name: Build, Test, and Deploy

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.dockerignore'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.dockerignore'

env:
  SERVICE_NAME: fm-session-service
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/faultmaven/fm-session-service
  IMAGE_TAG: sha-${{ github.sha }}
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: Build (no push)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ env.IMAGE_TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[dev] || python -m pip install .

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: docker load -i /tmp/image.tar

      - name: Run tests
        run: |
          set +e
          pytest --maxfail=1 --disable-warnings -q
          code=$?
          # pytest exit code 5 == "no tests collected" (acceptable for now; smoke is the gate)
          if [ "$code" -eq 5 ]; then
            echo "No tests collected; smoke test is the primary gate for now."
            exit 0
          fi
          exit "$code"

  smoke:
    name: Smoke test
    runs-on: ubuntu-latest
    needs: [build, test]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: docker load -i /tmp/image.tar

      - name: Run smoke test (/health)
        run: |
          set -euo pipefail
          docker network create smoke-net
          docker run -d --rm --name smoke-${{ github.sha }} --network smoke-net -p 8002:8002 \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

          passed=false
          for i in {1..30}; do
            if curl -sf http://localhost:8002/health; then
              echo "✓ Health check passed"
              passed=true
              break
            fi
            sleep 2
          done

          if [ "$passed" != "true" ]; then
            echo "✗ Health check failed"
            docker logs smoke-${{ github.sha }} || true
          fi

          docker stop smoke-${{ github.sha }}
          docker network rm smoke-net

          if [ "$passed" != "true" ]; then
            exit 1
          fi

  push-to-registry:
    name: Push image to GHCR
    runs-on: ubuntu-latest
    needs: [build, test, smoke]
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: docker load -i /tmp/image.tar

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image
        run: docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  deploy:
    name: Deploy to Production
    runs-on: [self-hosted, production]
    needs: push-to-registry
    if: github.ref == 'refs/heads/main'
    environment: on-prem
    steps:
      - name: Checkout enterprise-infra
        uses: actions/checkout@v4
        with:
          repository: FaultMaven/faultmaven-enterprise-infra
          token: ${{ secrets.INFRA_REPO_PAT }}
          path: infra

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.0.0'

      - name: Update image tag in K8s manifest
        run: |
          cd infra/kubernetes/apps/faultmaven/base/${{ env.SERVICE_NAME }}
          kustomize edit set image ${{ env.IMAGE_NAME }}=${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Deploy to Kubernetes
        run: |
          cd infra/kubernetes/apps/faultmaven/base/${{ env.SERVICE_NAME }}
          kubectl apply -k .
          kubectl rollout status deployment/${{ env.SERVICE_NAME }} -n faultmaven --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get deployment ${{ env.SERVICE_NAME }} -n faultmaven
          kubectl get pods -n faultmaven -l app=${{ env.SERVICE_NAME }}
          kubectl get service ${{ env.SERVICE_NAME }} -n faultmaven

      - name: Deployment summary
        if: success()
        run: |
          echo "### ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: faultmaven" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster**: production (192.168.0.100:6443)" >> $GITHUB_STEP_SUMMARY

      - name: Rollback on failure
        if: failure()
        run: |
          kubectl rollout undo deployment/${{ env.SERVICE_NAME }} -n faultmaven
          kubectl rollout status deployment/${{ env.SERVICE_NAME }} -n faultmaven --timeout=300s
