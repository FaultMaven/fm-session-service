name: Sync to Enterprise

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/generate-docs.yml'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: public

      - name: Checkout enterprise repo
        uses: actions/checkout@v4
        with:
          repository: FaultMaven/fm-session-service-enterprise
          token: ${{ secrets.ENTERPRISE_SYNC_TOKEN }}
          fetch-depth: 0
          path: enterprise

      - name: Configure git
        run: |
          cd enterprise
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch
        id: sync_branch
        run: |
          cd enterprise
          SYNC_BRANCH="sync/public-$(date +%Y%m%d-%H%M%S)"
          echo "branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$SYNC_BRANCH"

      - name: Sync changes with smart rules
        id: sync_changes
        run: |
          cd enterprise

          # Define auto-accept patterns (will be merged automatically)
          AUTO_ACCEPT_PATTERNS=(
            "src/session_service/models/"
            "src/session_service/api/routes/"
            "tests/unit/"
            "tests/integration/"
          )

          # Define manual-review patterns (will be flagged in PR)
          MANUAL_REVIEW_PATTERNS=(
            "src/session_service/main.py"
            "requirements.txt"
            "pyproject.toml"
            ".github/workflows/"
          )

          # Define never-overwrite patterns (enterprise-only files)
          NEVER_OVERWRITE_PATTERNS=(
            "README.md"
            ".github/workflows/sync-to-enterprise.yml"
          )

          # Copy files from public to enterprise, respecting rules
          rsync -av --delete \
            --exclude='.git/' \
            --exclude='README.md' \
            --exclude='.github/workflows/sync-to-enterprise.yml' \
            ../public/ ./

          # Check for changes
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ No changes to sync"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected:"
            git status --short
          fi

      - name: Commit and push changes
        if: steps.sync_changes.outputs.has_changes == 'true'
        run: |
          cd enterprise
          git add .

          # Get commit messages from public repo
          cd ../public
          PUBLIC_COMMITS=$(git log --oneline -5 --format="- %s")

          cd ../enterprise
          git commit -m "sync: Merge changes from public repository

          Recent public commits:
          $PUBLIC_COMMITS

          ğŸ”„ Auto-synced from public repo
          ğŸ“… Sync timestamp: $(date -u +'%Y-%m-%d %H:%M UTC')

          Review Notes:
          - Auto-accepted: models/, routes/, tests/
          - Please review: main.py, requirements.txt if changed
          - Protected: README.md, enterprise-only configs"

          git push origin ${{ steps.sync_branch.outputs.branch }}

      - name: Create Pull Request
        if: steps.sync_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.ENTERPRISE_SYNC_TOKEN }}
        run: |
          cd enterprise

          # Create PR body
          PR_BODY=$(cat <<'EOF'
          ## ğŸ”„ Automated Public â†’ Enterprise Sync

          This PR syncs changes from the public repository to enterprise.

          ### ğŸ“Š Sync Details
          - **Source**: [fm-session-service](https://github.com/FaultMaven/fm-session-service)
          - **Timestamp**: ${{ github.event.head_commit.timestamp }}
          - **Trigger**: Public repo push to main

          ### âœ… Auto-Accepted Changes
          Files in these directories are automatically merged:
          - `src/session_service/models/` - Data models
          - `src/session_service/api/routes/` - API endpoints
          - `tests/` - Test files

          ### âš ï¸ Manual Review Required
          Please carefully review changes to:
          - `src/session_service/main.py` - May affect enterprise initialization
          - `requirements.txt` / `pyproject.toml` - Dependency changes
          - `.github/workflows/` - CI/CD configurations

          ### ğŸ”’ Protected Files (Not Modified)
          These files are never overwritten:
          - `README.md` - Enterprise-specific documentation
          - Enterprise-only configuration files

          ### ğŸš€ Testing Checklist
          - [ ] Unit tests pass
          - [ ] Integration tests pass
          - [ ] Enterprise-specific features still work
          - [ ] Multi-tenancy isolation verified
          - [ ] No proprietary IP leaked to public

          ---

          ğŸ¤– This PR was automatically created by the sync workflow.
          EOF
          )

          # Create PR using gh CLI
          gh pr create \
            --repo FaultMaven/fm-session-service-enterprise \
            --head "${{ steps.sync_branch.outputs.branch }}" \
            --base main \
            --title "ğŸ”„ Sync from public repository" \
            --body "$PR_BODY"

      - name: Summary
        run: |
          if [ "${{ steps.sync_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Sync PR created successfully"
            echo "Branch: ${{ steps.sync_branch.outputs.branch }}"
            echo "Review the PR at: https://github.com/FaultMaven/fm-session-service-enterprise/pulls"
          else
            echo "âœ… Repositories are already in sync"
            echo "No action needed"
          fi
